
@{
    ViewBag.Title = "Prediction";
}

<h2>Prediction</h2>

@using (Html.BeginForm("Index", "Predict", FormMethod.Post, new { @id = "frmPredict", @enctype = "multipart/form-data" }))
{
    <table border="0" cellpadding="0" cellspacing="0">
        <tr valign="top">
            <td>
                <input type="file" id="ImageFile" name="ImageFile" />
            </td>
            <td>&nbsp;&nbsp;&nbsp;</td>
            <td>
                <div id="Processing"></div>
            </td>
        </tr>
    </table>

    <script type="text/javascript">
        document.getElementById("ImageFile").onchange = function () {
            //document.getElementById("Processing").value = "Processing...";
            $('#Processing').text('Processing...');
            document.getElementById("frmPredict").submit();
        };
    </script>
}

<br />

@if (ViewData["ImageBase64String"] != null && ViewData["ImageBase64String"].ToString().Trim().Length > 0)
{
    using (Ajax.BeginForm("Predict", "Predict", new AjaxOptions { HttpMethod = "POST", OnBegin = "frmPredict_Begin", OnSuccess = "frmPredict_Success", OnFailure = "frmPredict_Failure" }, new { @id = "frmPredict" }))
    {
        <table border="0" cellpadding="0" cellspacing="0">
            <tr valign="top">
                <td>
                    <div class="image-cropper">
                        <input type="hidden" name="ImageBase64String" id="ImageBase64String" value="@ViewData["ImageBase64String"]" />
                        <input type="hidden" name="ImageContentType" id="ImageContentType" value="@ViewData["ImageContentType"]" />
                        <input type="hidden" name="ImageContentLength" id="ImageContentLength" value="@ViewData["ImageContentLength"]" />
                        <input type="hidden" name="ImageExtension" id="ImageExtension" value="@ViewData["ImageExtension"]" />
                        <input type="hidden" name="ImageCoordsX" id="ImageCoordsX" value="" />
                        <input type="hidden" name="ImageCoordsY" id="ImageCoordsY" value="" />
                        <input type="hidden" name="ImageCoordsX2" id="ImageCoordsX2" value="" />
                        <input type="hidden" name="ImageCoordsY2" id="ImageCoordsY2" value="" />
                        <img class="image" name="ImageDisplay" id="ImageDisplay" src="data:@ViewData["ImageContentType"];base64,@ViewData["ImageBase64String"]"><br />
                    </div>
                    <script type="text/javascript">
                        SetImageCropper($("#ImageDisplay"))
                    </script>
                </td>
                <td>
                    &nbsp;&nbsp;&nbsp;
                </td>
                <td>
                    Select area on image and click Predict button.<br /><br />
                    <input type="submit" id="Predict" name="Predict" value="Predict" />
                    <script type="text/javascript">
                        $("#Predict").prop("disabled", true);
                    </script>
                    <br /><br />
                    <div id="PredictImageDisplay"></div>
                    <br /><br />
                    <div id="PercentageDisclaimer"></div>
                    <br /><br />
                    <table id="tblPredictionResult"></table>
                    <style>
                        table#tblPredictionResult {
                            border-collapse: collapse;
                            width: 100%;
                        }

                            table#tblPredictionResult th, table#tblPredictionResult td {
                                text-align: left;
                                padding: 8px;
                            }

                            table#tblPredictionResult tr:nth-child(even) {
                                background-color: #f2f2f2
                            }

                            table#tblPredictionResult th {
                                background-color: #4CAF50;
                                color: white;
                            }
                    </style>
                </td>
            </tr>
        </table>
        <br />
        <table id="tblInventory"></table>
    }
}

@section OptionalScript
{
<script type="text/javascript">
    jQuery.browser = {};
    (function () {
        jQuery.browser.msie = false;
        jQuery.browser.version = 0;
        if (navigator.userAgent.match(/MSIE ([0-9]+)\./)) {
            jQuery.browser.msie = true;
            jQuery.browser.version = RegExp.$1;
        }
    })();
</script>
<script src="~/Scripts/jquery.Jcrop.js" type="text/javascript"></script>
<link href="~/Content/jquery.Jcrop.css" type="text/css" rel="stylesheet" />
<script type="text/javascript">
    function SetImageCropper(image) {
        //Define a function to execute when the cropping rectangle changes.
        var update = function (coords) {
            if (parseInt(coords.w) <= 0 || parseInt(coords.h) <= 0) {
                $("#Predict").prop("disabled", true);
                return; //Require valid width and height
            }
            else {
                $("#Predict").prop("disabled", false);
                $("#ImageCoordsX").val(coords.x);
                $("#ImageCoordsY").val(coords.y);
                $("#ImageCoordsX2").val(coords.x2);
                $("#ImageCoordsY2").val(coords.y2);

                //Build the URL based on the coordiantes. The resizing module will handle everything else.
                //var url = path + '?crop=(' + coords.x + ',' + coords.y + ',' + coords.x2 + ',' + coords.y2 +
                //   ')&cropxunits=' + image.width() + '&cropyunits=' + image.height()
            }
        }

        //Start up jCrop on the image, specifying our function be called when the selection rectangle changes,
        // and that a 60% black shadow should cover the cropped regions.
        image.Jcrop({ onChange: update, onSelect: update, bgColor: 'black', bgOpacity: 0.6 });
    }

    function frmPredict_Success(data, status, xhr) {
        $("#Predict").prop("value", "Predict");
        $("#Predict").prop("disabled", false);

        if (status == "success" && xhr.status == 200) {
            $("#PredictImageDisplay").html("<img src='data:" + data.PredictionImageContentType + ";base64," + data.PredictionImageBase64String + "' width='300' />");
            $("#PercentageDisclaimer").text("Images with tags matching more than or equal to " + data.MinimumPredictionPercentage + " prediction percentage will be shown below.");

            displayPredictionResult(data);

            displayInventory(data);
        }
        else {
            displayError("Error occurred.");
        }
    }

    function frmPredict_Failure(xhr, status, error) {
        $("#Predict").prop("value", "Predict");
        $("#Predict").prop("disabled", false);

        displayError(error);
    }

    function frmPredict_Begin(xhr) {
        $("#Predict").prop("value", "Predicting...");
        $("#Predict").prop("disabled", true);
    }

    function displayPredictionResult(data) {
        var content = "<tr valign='top'><th>tag</th><th>percentage</th></tr>";

        for (var i = 0; i < data.PredictionResult.Predictions.length; i++) {
            content += "<tr valign='top'><td>" + data.PredictionResult.Predictions[i].Tag + "</td><td>" + (Math.round(data.PredictionResult.Predictions[i].Probability * 10000)/100).toString() + "</td></tr>";
        }

        $("#tblPredictionResult").html(content);
    }

    function displayInventory(data) {
        $("#tblInventory").prop("border", "2");
        $("#tblInventory").prop("style", "border: 1px solid black;");
        $("#tblInventory").prop("cellpadding", "5");
        $("#tblInventory").prop("cellspacing", "5");

        var content = "<tr valign='middle'>";

        for (var i = 0; i < data.Images.length; i++) {
            content += "<td><img src='ImageFiles/" + data.Images[i].Filename + "' width='350' /><br /></td>";
            if (((i + 1) % 3) == 0) {
                content += "</tr><tr valign='middle'>";
            }
        }

        if ((i % 3) != 0) {
            for (var r = 1; r <= (3 - (i % 3)); r++) {
                content += "<td>&nbsp;</td>";
            }
        }

        content += "</tr>";

        $("#tblInventory").html(content);
    }

    function displayError(error) {
        $("#PredictImageDisplay").text(error);

        $("#PercentageDisclaimer").text("");

        $("#tblPredictionResult").html("");

        $("#tblInventory").html("");
        $("#tblInventory").removeProp("border");
        $("#tblInventory").removeProp("style");
        $("#tblInventory").removeProp("cellpadding");
        $("#tblInventory").removeProp("cellspacing");

    }
</script>

}